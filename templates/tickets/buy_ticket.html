<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ event.title }} - Purchase Tickets</title>
</head>
<body>
    <h1>{{ event.title }}</h1>
    {% if event.poster %}
        <img src="{{ event.poster.url }}" alt="{{ event.title }} poster">
    {% else %}
        <p>No image available</p>
    {% endif %}
    <p><strong>Description:</strong> {{ event.description }}</p>
    <p><strong>Category:</strong> {{ event.category }}</p>
    <p><strong>Start Date:</strong> {{ event.start_date|date:"F d, Y" }}</p>

    {% if event.end_date %}
        <p><strong>End Date:</strong> {{ event.end_date|date:"F d, Y" }}</p>
    {% endif %}
    <p><strong>Venue:</strong> {{ event.venue_name }}</p>
    <p><strong>Price:</strong> {{ event.sale_price }}</p>

    {% if categories %}
        <h2>Ticket Categories</h2>
        <ul>
            {% for category in categories %}
            <li>
                <h3>{{ category.category_title }}</h3>
                <p><strong>Price:</strong> {{ category.category_price }}</p>
                {% if category.category_tickets_available > 0 %}
                    {% if category.category_tickets_available >= category_thresholds.category.id %}
                        <p>Tickets Available</p>
                    {% else %}
                        <p>Tickets Almost Sold Out</p>
                    {% endif %}
                {% else %}
                    <p>Tickets Sold Out</p>
                {% endif %}
            </li>
        {% endfor %}
        
        </ul>
    {% endif %}

    <h2>Purchase Tickets</h2>
    <form method="post">
        {% csrf_token %}
        <table>
            <tr>
                <th>Ticket Category</th>
                <th>Price</th>
                <th>Number of Tickets</th>
                <th>Total</th>
            </tr>
            {% if categories %}
                {% for category in categories %}
                    <tr>
                        <td>{{ category.category_title }}</td>
                        <td>{{ category.category_price }}</td>
                        <td><input type="number" name="quantity_{{ category.id }}" value="0" min="0" max="{{ category.category_tickets_available }}"></td>
                        <td class="total_price">0</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td>Ordinary</td>
                    <td>{{ event.sale_price }}</td>
                    <td><input type="number" name="quantity_ordinary" value="1" min="1" max="{{ event.tickets_available }}"></td>
                    <td class="total_price">{{ event.sale_price }}</td>
                </tr>
            {% endif %}
            <tr>
                <td colspan="3"><strong>Total:</strong></td>
                <td id="grand_total">0</td>
            </tr>
        </table>
        <button type="submit">Generate Ticket</button>
    </form>

    <!-- Inline JavaScript to handle the ticket calculations -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ticketRows = document.querySelectorAll('tr');
            const grandTotal = document.getElementById('grand_total');

            ticketRows.forEach(row => {
                const quantityInput = row.querySelector('input[type="number"]');
                const totalPrice = row.querySelector('.total_price');

                if (quantityInput) {
                    quantityInput.addEventListener('input', function() {
                        const price = parseFloat(row.querySelector('td:nth-child(2)').innerText);
                        const quantity = parseInt(quantityInput.value);
                        const total = price * quantity;

                        totalPrice.innerText = total.toFixed(2);
                        updateGrandTotal();
                    });
                }
            });

            function updateGrandTotal() {
                let sum = 0;
                document.querySelectorAll('.total_price').forEach(priceCell => {
                    sum += parseFloat(priceCell.innerText);
                });
                grandTotal.innerText = sum.toFixed(2);
            }
        });
    </script>
</body>
</html>
