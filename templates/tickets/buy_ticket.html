<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ event.title }} - Purchase Tickets</title>
</head>
<body>
    <h1>{{ event.title }}</h1>
    {% if event.poster %}
        <img src="{{ event.poster.url }}" alt="{{ event.title }} poster">
    {% else %}
        <p>No image available</p>
    {% endif %}
    <p><strong>Description:</strong> {{ event.description }}</p>
    <p><strong>Category:</strong> {{ event.category }}</p>
    <p><strong>Start Date:</strong> {{ event.start_date|date:"F d, Y" }}</p>

    {% if event.end_date %}
        <p><strong>End Date:</strong> {{ event.end_date|date:"F d, Y" }}</p>
    {% endif %}
    <p><strong>Venue:</strong> {{ event.venue_name }}</p>
    <p><strong>Price:</strong> {{ event.sale_price }}</p>

    {% if ticket_data %}
        <h2>Ticket Categories</h2>
        <ul>
            {% for data in ticket_data %}
            <li>
                <h3>{{ data.category.category_title }}</h3>
                <p><strong>Price:</strong> {{ data.category.category_price }}</p>
                {% if data.tickets_remaining > 0 %}
                <p><strong>Tickets:</strong> {{ data.tickets_remaining }} tickets</strong></p>
                {% else %}
                    <p style="color: red;"><strong>Sold Out</strong></p>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% endif %}

    {% if ordinary_ticket_data %}
        <h2>Ordinary Ticket</h2>
        <ul>
            <li>
                <h3>Ordinary</h3>
                <p><strong>Price:</strong> {{ ordinary_ticket_data.price }}</p>
                {% if ordinary_ticket_data.tickets_remaining > 0 %}
                    <p><strong>Tickets:</strong> {{ ordinary_ticket_data.tickets_remaining }}</strong></p>
                {% else %}
                    <p style="color: red;"><strong>Sold Out</strong></p>
                {% endif %}
            </li>
        </ul>
    {% endif %}

    <h2>Purchase Tickets</h2>
    <form method="post">
        {% csrf_token %}
        <table>
            <tr>
                <th>Ticket Category</th>
                <th>Price</th>
                <th>Number of Tickets</th>
                <th>Total</th>
            </tr>
            {% if ticket_data %}
                {% for data in ticket_data %}
                    <tr>
                        <td>{{ data.category.category_title }}</td>
                        <td>{{ data.category.category_price }}</td>
                        {% if data.tickets_remaining > 0 %}
                            <td><input type="number" name="quantity_{{ data.category.id }}" value="0" min="0" max="{{ data.tickets_remaining }}"></td>
                            <td class="total_price">0</td>
                        {% else %}
                            <td colspan="2" style="color: red;"><strong>Sold Out</strong></td>
                        {% endif %}
                    </tr>
                {% endfor %}
            {% endif %}
            {% if ordinary_ticket_data %}
                <tr>
                    <td>Ordinary</td>
                    <td>{{ ordinary_ticket_data.price }}</td>
                    {% if ordinary_ticket_data.tickets_remaining > 0 %}
                        <td><input type="number" name="quantity_ordinary" value="1" min="1" max="{{ ordinary_ticket_data.tickets_remaining }}"></td>
                        <td class="total_price">{{ ordinary_ticket_data.price }}</td>
                    {% else %}
                        <td colspan="2" style="color: red;"><strong>Sold Out</strong></td>
                    {% endif %}
                </tr>
            {% endif %}
            <tr>
                <td colspan="3"><strong>Total:</strong></td>
                <td id="grand_total">0</td>
            </tr>
        </table>
        <button type="submit">Generate Ticket</button>
    </form>

    <!-- Inline JavaScript to handle the ticket calculations -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ticketRows = document.querySelectorAll('tr');
            const grandTotal = document.getElementById('grand_total');

            ticketRows.forEach(row => {
                const quantityInput = row.querySelector('input[type="number"]');
                const totalPrice = row.querySelector('.total_price');

                if (quantityInput) {
                    quantityInput.addEventListener('input', function() {
                        const price = parseFloat(row.querySelector('td:nth-child(2)').innerText);
                        const quantity = parseInt(quantityInput.value);
                        const total = price * quantity;

                        totalPrice.innerText = total.toFixed(2);
                        updateGrandTotal();
                    });
                }
            });

            function updateGrandTotal() {
                let sum = 0;
                document.querySelectorAll('.total_price').forEach(priceCell => {
                    sum += parseFloat(priceCell.innerText);
                });
                grandTotal.innerText = sum.toFixed(2);
            }
        });
    </script>
</body>
</html>
